<!DOCTYPE html>
<html lang="en">
  <head>
    <title>QUANTRA 0.5 | AI POWERED WEATHER WEB APP</title>
    <link rel="stylesheet" href="/static/quantra/ai_mode.css?v=2" />
    <link
      href="https://fonts.googleapis.com/css2?family=Urbanist:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/png"
      href="/static/quantra/RESOURCES/APPLICATION_ICON/ICON3.png"
    />
  </head>
  <body>
    <div class="main">
      <nav class="navbar1">
        <a href="/">HOME</a>
        <a id="todayLink" href="#">TODAY</a>
        <a id="weeklyLink" href="#">WEEKLY</a>
        <a href="/maps">MAPS</a>
        <a href="/about">ABOUT ME</a>
      </nav>

      <div class="theme-toggle">
        <img
          src="/static/quantra/RESOURCES/THEAME_SWITCHER/sun.png"
          alt="Sun"
          class="sun"
        />
        <img
          src="/static/quantra/RESOURCES/THEAME_SWITCHER/MOON.png"
          alt="Moon"
          class="moon"
        />
        <div class="toggle-button" id="toggle-btn"></div>
      </div>

      <div class="ai-container">
        <div class="ai-header">
          <h2>QUANTRA 0.5</h2>
          <p class="eyebrow">POWERED BY QUANTRA UNIVERSE</p>
        </div>
        <div class="ai-main">
          <div class="chat-messages" id="ChatMessages">
            <div class="message ai-message" id="DefaultMessage"></div>
            <div class="scrollbar"></div>
          </div>
          <div class="search-row">
            <input
              type="text"
              id="QueryInput"
              placeholder="ASK ME ANYTHING HERE..."
            />
            <button type="button" id="SendBtn">SEND</button>
          </div>
        </div>
      </div>
    </div>

    <div id="customAlert" class="custom-alert-overlay">
      <div class="custom-alert-box">
        <h2 class="custom-alert-title">NOTICE</h2>
        <p class="custom-alert-message" id="alertMessage">
          PLEASE SEARCH THE LOCATION FIRST!
        </p>
        <button class="custom-alert-btn" id="alertBtn">GOT IT</button>
      </div>
    </div>

    <script>
      const themeToggle = document.querySelector(".theme-toggle");
      const body = document.body;
      const mainDiv = document.querySelector(".main");

      themeToggle.addEventListener("click", () => {
        body.classList.toggle("dark");

        if (body.classList.contains("dark")) {
          body.style.backgroundImage =
            "url('/static/quantra/RESOURCES/TEXTURES/MILKY_WAY.jpg')";
          mainDiv.style.backgroundImage =
            "url('/static/quantra/RESOURCES/TEXTURES/MILKY_WAY.jpg')";
        } else {
          body.style.backgroundImage =
            "url('/static/quantra/RESOURCES/SKY/SKY-5.jpg')";
          mainDiv.style.backgroundImage =
            "url('/static/quantra/RESOURCES/SKY/SKY-5.jpg')";
        }
      });

      const customAlert = document.getElementById("customAlert");
      const alertMessage = document.getElementById("alertMessage");
      const alertBtn = document.getElementById("alertBtn");

      function showAlert(msg) {
        if (msg) alertMessage.textContent = msg;
        customAlert.classList.add("show");
      }

      function closeAlert() {
        customAlert.classList.remove("show");
      }

      alertBtn.addEventListener("click", closeAlert);

      customAlert.addEventListener("click", (e) => {
        if (e.target === customAlert) {
          closeAlert();
        }
      });

      function showNavAlert(e) {
        e.preventDefault();
        showAlert("PLEASE SEARCH THE LOCATION FIRST! FROM HOME PAGE");
      }

      document
        .getElementById("todayLink")
        .addEventListener("click", showNavAlert);
      document
        .getElementById("weeklyLink")
        .addEventListener("click", showNavAlert);

      const chatMessages = document.getElementById("ChatMessages");
      const queryInput = document.getElementById("QueryInput");
      const sendBtn = document.getElementById("SendBtn");

      function getWeatherIcon(code) {
        if (code <= 3) return "/static/quantra/RESOURCES/AI_WEDGET/SUNNY.jpg";

        if (
          (code >= 51 && code <= 67) ||
          (code >= 80 && code <= 82) ||
          (code >= 95 && code <= 99)
        ) {
          return "/static/quantra/RESOURCES/AI_WEDGET/RAINY.jpg";
        }

        if (
          (code >= 71 && code <= 77) ||
          (code >= 85 && code <= 86) ||
          code === 45 ||
          code === 48
        ) {
          return "/static/quantra/RESOURCES/AI_WEDGET/WINTER.jpg";
        }

        return "/static/quantra/RESOURCES/AI_WEDGET/SUNNY.jpg"; // Default
      }

      function addMessage(role, content) {
        const msgDiv = document.createElement("div");
        msgDiv.className = `message ${role}-message`;

        if (role === "ai") {
          if (content.startsWith("WIDGET_WEATHER:")) {
            try {
              const data = JSON.parse(content.replace("WIDGET_WEATHER:", ""));
              const icon = getWeatherIcon(data.code);

              msgDiv.innerHTML = `
                <div class="weather-widget">
                  <div class="weather-left">
                    <img src="${icon}" class="weather-icon-img">
                    <div class="weather-temp-val">${data.temp}${data.unit}</div>
                  </div>
                  <div class="weather-right">
                    <div class="weather-city-name">${data.city.toUpperCase()}</div>
                    <div class="weather-detail">WIND: ${data.wind} KM/H</div>
                    <div class="weather-detail">CONDITION: ${
                      data.code === 0 ? "CLEAR" : "CLOUDY"
                    }</div>
                  </div>
                </div>
              `;
              chatMessages.appendChild(msgDiv);
              chatMessages.scrollTop = chatMessages.scrollHeight;
              return;
            } catch (e) {
              console.error("Widget parse error:", e);
              content = "SORRY, I FAILED TO RENDER THE WEATHER WIDGET.";
            }
          }

          content = content.replace(
            "QUANTRA 0.5",
            '<span class="ai-name">QUANTRA 0.5</span>'
          );

          msgDiv.classList.add("typing");
          chatMessages.appendChild(msgDiv);
          typeWriter(msgDiv, content, () => {
            msgDiv.classList.remove("typing");
          });
        } else {
          msgDiv.innerHTML = content;
          chatMessages.appendChild(msgDiv);
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function typeWriter(element, html, callback) {
        let i = 0;
        const speed = 30;

        const temp = document.createElement("div");
        temp.innerHTML = html;
        const contentParts = [];

        temp.childNodes.forEach((child) => {
          if (child.nodeType === Node.TEXT_NODE) {
            contentParts.push({ type: "text", value: child.textContent });
          } else if (child.nodeType === Node.ELEMENT_NODE) {
            contentParts.push({
              type: "tag",
              tag: child.outerHTML,
              text: child.textContent,
            });
          }
        });

        let currentPartIndex = 0;
        let currentCharIndex = 0;
        element.innerHTML = "";

        function type() {
          if (currentPartIndex < contentParts.length) {
            const part = contentParts[currentPartIndex];
            if (part.type === "text") {
              element.innerHTML += part.value.charAt(currentCharIndex);
              currentCharIndex++;
              if (currentCharIndex >= part.value.length) {
                currentPartIndex++;
                currentCharIndex = 0;
              }
            } else if (part.type === "tag") {
              element.innerHTML += part.tag;
              currentPartIndex++;
              currentCharIndex = 0;
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
            setTimeout(type, speed);
          } else {
            if (callback) callback();
          }
        }
        type();
      }

      function addTypingIndicator() {
        const msgDiv = document.createElement("div");
        msgDiv.className = "message ai-message typing-indicator";
        msgDiv.id = "typingIndicator";
        msgDiv.innerHTML = "QUANTRA 0.5 IS THINKING...";
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function removeTypingIndicator() {
        const indicator = document.getElementById("typingIndicator");
        if (indicator) indicator.remove();
      }

      async function sendQuery(query, city = null) {
        if (!query) return;

        addMessage("user", query);
        queryInput.value = "";
        addTypingIndicator();

        try {
          const response = await fetch("http://localhost:8000/query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query, city }),
          });
          const data = await response.json();
          removeTypingIndicator();
          addMessage("ai", data.response);
        } catch (error) {
          removeTypingIndicator();
          console.error("Error connecting to backend:", error);
          addMessage(
            "ai",
            "SORRY, I'M HAVING TROUBLE CONNECTING TO MY BRAIN (BACKEND). MAKE SUREmain.py IS RUNNING!"
          );
        }
      }

      sendBtn.addEventListener("click", (e) => {
        e.preventDefault();
        sendQuery(queryInput.value);
      });

      queryInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendQuery(queryInput.value);
        }
      });

      window.addEventListener("load", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const city = urlParams.get("city");
        const action = urlParams.get("action");

        if (city && action === "weather") {
          setTimeout(() => {
            sendQuery(`HOW IS THE WEATHER IN ${city.toUpperCase()}?`, city);
          }, 1000);
        } else {
          setTimeout(() => {
            const defaultMsg = document.getElementById("DefaultMessage");
            defaultMsg.classList.add("typing");
            const text =
              'HELLO! I AM <span class="ai-name">QUANTRA 0.5</span> HOW CAN I HELP YOU TODAY?';
            typeWriter(defaultMsg, text, () => {
              defaultMsg.classList.remove("typing");
            });
          }, 2000);
        }
      });
    </script>
  </body>
</html>
